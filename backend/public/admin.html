<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Celiyo Meet - Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-body: #f8fafc;
        --bg-surface: #ffffff;

        --text-primary: #0f172a;
        --text-secondary: #334155;
        --text-tertiary: #94a3b8;

        --accent: #2563eb;
        --accent-subtle: #eff6ff;

        --border-light: #e2e8f0;

        --radius-sm: 8px;
        --radius-card: 16px;

        --font-ui: "Inter", sans-serif;
        --font-display: "Space Grotesk", sans-serif;

        --shadow-card: 0 4px 6px -1px rgb(0 0 0 / 0.05),
          0 2px 4px -2px rgb(0 0 0 / 0.05);
        --shadow-hover: 0 20px 25px -5px rgb(0 0 0 / 0.05),
          0 8px 10px -6px rgb(0 0 0 / 0.01);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-ui);
        background: var(--bg-body);
        color: var(--text-primary);
        line-height: 1.6;
        padding-bottom: 80px;
        -webkit-font-smoothing: antialiased;
      }

      /* Login Screen */
      #login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 20px;
      }

      .login-card {
        background: white;
        padding: 48px;
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.1);
        width: 100%;
        max-width: 400px;
        text-align: center;
      }

      .login-logo {
        width: 56px;
        height: 56px;
        background: var(--text-primary);
        border-radius: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin-bottom: 24px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .login-title {
        font-family: var(--font-display);
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text-primary);
      }

      .login-input {
        width: 100%;
        padding: 14px;
        margin-bottom: 16px;
        border: 1px solid var(--border-light);
        border-radius: 12px;
        font-size: 15px;
        outline: none;
        transition: border-color 0.2s;
        background: #f8fafc;
      }
      .login-input:focus {
        border-color: var(--accent);
        background: white;
      }

      .login-btn {
        width: 100%;
        padding: 14px;
        background: var(--text-primary);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .login-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      /* SVG Icons */
      .anim-icon {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        stroke-width: 1.5;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .icon-draw path,
      .icon-draw circle,
      .icon-draw line,
      .icon-draw polyline {
        stroke-dasharray: 100;
        stroke-dashoffset: 100;
        animation: drawIcon 1.5s ease-out forwards;
      }
      @keyframes drawIcon {
        to {
          stroke-dashoffset: 0;
        }
      }

      /* Header */
      header {
        position: sticky;
        top: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        z-index: 100;
        border-bottom: 1px solid var(--border-light);
        padding: 16px 0;
      }

      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 24px;
        width: 100%;
      }

      .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 16px;
      }

      .logo-group {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo-icon {
        width: 32px;
        height: 32px;
        background: var(--text-primary);
        border-radius: 8px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .logo-text {
        font-family: var(--font-display);
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .nav-group {
        display: flex;
        gap: 4px;
        background: #f1f5f9;
        padding: 4px;
        border-radius: 12px;
      }
      .nav-pill {
        padding: 6px 16px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      .nav-pill:hover {
        color: var(--text-primary);
      }
      .nav-pill.active {
        background: white;
        color: var(--text-primary);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      /* Filters responsive */
      .toolbar {
        margin: 32px 0;
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .search-bar {
        flex: 1 1 300px; /* Grow, Shrink, Basis */
        height: 48px;
        background: white;
        border: 1px solid var(--border-light);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        padding: 0 16px;
        gap: 12px;
        transition: all 0.2s;
      }
      .search-bar:focus-within {
        border-color: var(--text-tertiary);
        box-shadow: 0 0 0 3px #f1f5f9;
      }
      .search-input {
        flex: 1;
        border: none;
        font-size: 15px;
        outline: none;
        color: var(--text-primary);
        font-family: var(--font-ui);
        min-width: 0;
      }

      .date-select {
        height: 48px;
        border: 1px solid var(--border-light);
        background: white;
        border-radius: var(--radius-sm);
        padding: 0 16px;
        font-family: var(--font-ui);
        color: var(--text-secondary);
        outline: none;
        flex: 0 1 auto; /* Allow shrink but prefer width */
      }

      /* Card Responsive */
      .meeting-card {
        background: white;
        border-radius: var(--radius-card);
        margin-bottom: 24px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
        box-shadow: var(--shadow-card);
      }
      .meeting-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
      }

      .card-header {
        padding: 24px;
        cursor: pointer;
      }

      .header-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .date-badge {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-tertiary);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .expand-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        color: var(--text-secondary);
        flex-shrink: 0;
      }
      .meeting-card.active .expand-circle {
        background: var(--text-primary);
        color: white;
        border-color: var(--text-primary);
        transform: rotate(180deg);
      }

      .topic-headline {
        font-family: var(--font-display);
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.3;
        margin-bottom: 8px;
      }

      .topic-preview {
        font-size: 15px;
        color: var(--text-secondary);
        line-height: 1.6;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* Expanded Content */
      .card-content {
        display: none;
        padding: 0 24px 32px;
        border-top: 1px solid var(--border-light);
        animation: fadeIn 0.5s ease;
      }
      .meeting-card.active .card-content {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Summary Blocks */
      .summary-block {
        margin-top: 32px;
        padding-left: 0;
        position: relative;
      }

      .block-header-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
      }

      .block-icon {
        position: relative;
        width: 32px;
        height: 32px;
        color: var(--accent);
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .block-title {
        font-family: var(--font-display);
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.4;
      }

      /* Readable Text Lists */
      .readable-text ul {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .readable-text li {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        font-size: 16px;
        line-height: 1.6;
        color: var(--text-secondary);
        text-align: left;
      }

      .readable-text li .bullet {
        flex-shrink: 0;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--border-light);
        border: 1px solid var(--text-tertiary);
        margin-top: 10px;
      }
      .readable-text li .checkbox {
        flex-shrink: 0;
        width: 18px;
        height: 18px;
        border: 1.5px solid var(--text-tertiary);
        border-radius: 4px;
        margin-top: 4px;
      }
      .readable-text li .num-marker {
        font-weight: 700;
        color: var(--text-primary);
        min-width: 24px;
      }

      .readable-text strong {
        color: var(--text-primary);
        font-weight: 700;
      }
      .readable-text p {
        margin-bottom: 24px;
      }

      /* Transcript Highlight */
      .transcript-module {
        width: 100%;
        display: block;
        background: #f8fafc;
        border: 1px solid #cbd5e1;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 32px;
        transition: all 0.2s;
      }
      .transcript-module:hover {
        border-color: var(--accent);
        background: #f1f5f9;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      }

      .transcript-head {
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
        color: var(--text-primary);
        font-size: 15px;
      }

      .transcript-body {
        display: none;
        padding: 24px;
        border-top: 1px solid #e2e8f0;
        font-family: "Inter", sans-serif;
        font-size: 14px;
        line-height: 1.8;
        color: var(--text-secondary);
        max-height: 400px;
        overflow-y: auto;
        background: white;
      }
      .transcript-module.open .transcript-body {
        display: block;
      }

      /* Buttons & Footer */
      .btn {
        height: 40px;
        padding: 0 20px;
        border-radius: var(--radius-sm);
        font-size: 14px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid var(--border-light);
        background: white;
        color: var(--text-secondary);
        white-space: nowrap;
      }
      .btn:hover {
        border-color: var(--text-primary);
        color: var(--text-primary);
      }

      /* Colored Buttons */
      .btn-green {
        border-color: #22c55e60;
        color: #166534;
        background: #f0fdf4;
      }
      .btn-green:hover {
        background: #22c55e;
        color: white;
        border-color: #22c55e;
      }

      .btn-red {
        border-color: #ef444460;
        color: #991b1b;
        background: #fef2f2;
      }
      .btn-red:hover {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
      }

      .action-bar {
        margin-top: 32px;
        padding-top: 32px;
        border-top: 1px solid var(--border-light);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        flex-wrap: wrap;
      }

      .btn-logout {
        background: transparent;
        border: none;
        font-weight: 600;
        color: #ef4444;
        cursor: pointer;
        padding: 8px 16px;
        font-size: 14px;
      }
      .btn-logout:hover {
        color: #dc2626;
        text-decoration: underline;
      }

      /* Media Queries */
      @media (max-width: 640px) {
        .nav-group {
          width: 100%;
          justify-content: center;
        }
        .toolbar {
          flex-direction: column;
          align-items: stretch;
        }
        .date-select {
          width: 100%;
        }
        .card-header {
          padding: 20px;
        }
        .card-content {
          padding: 0 20px 24px;
        }
        .topic-headline {
          font-size: 18px;
        }
        .block-title {
          font-size: 16px;
        }
        .readable-text li {
          font-size: 15px;
        }
        .action-bar {
          justify-content: stretch;
        }
        .action-bar .btn {
          flex: 1;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login Overlay -->
    <div id="login-overlay" style="display: none">
      <div class="login-card">
        <div class="login-logo">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="3"
          >
            <path d="M21 12a9 9 0 1 1-6.219-8.56" />
          </svg>
        </div>
        <div class="login-title">Celiyo Meet</div>
        <p
          style="
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 15px;
          "
        >
          Admin Intelligence Access
        </p>
        <form onsubmit="doLogin(event)">
          <input
            class="login-input"
            type="email"
            id="u"
            placeholder="Admin Email"
            required
          />
          <input
            class="login-input"
            type="password"
            id="p"
            placeholder="Password"
            required
          />
          <button class="login-btn">Sign In</button>
        </form>
      </div>
    </div>

    <header>
      <div class="container header-row">
        <div class="logo-group">
          <div class="logo-icon">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
            >
              <path d="M21 12a9 9 0 1 1-6.219-8.56" />
            </svg>
          </div>
          <div class="logo-text">Celiyo Meet</div>
        </div>

        <div class="nav-group">
          <div class="nav-pill active" id="tab-feed" onclick="switchTab(false)">
            Feed
          </div>
          <div class="nav-pill" id="tab-arch" onclick="switchTab(true)">
            Archived
          </div>
        </div>

        <div>
          <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="toolbar">
        <div class="search-bar">
          <svg
            class="anim-icon"
            style="width: 18px; color: #94a3b8"
            viewBox="0 0 24 24"
          >
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
          </svg>
          <input
            type="text"
            class="search-input"
            id="search"
            placeholder="Search insights..."
            onkeyup="refresh()"
          />
        </div>
        <input
          type="date"
          class="date-select"
          id="d-start"
          onchange="refresh()"
        />
        <input
          type="date"
          class="date-select"
          id="d-end"
          onchange="refresh()"
        />
        <button
          class="btn"
          style="width: 48px; padding: 0; justify-content: center"
          onclick="reset()"
        >
          <svg class="anim-icon" style="width: 16px" viewBox="0 0 24 24">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
            <path d="M3 3v5h5" />
          </svg>
        </button>
      </div>

      <div id="feed"></div>
    </div>

    <script>
      const API = "http://localhost:3001/api";
      const ICONS = {
        summary: `<svg class="anim-icon icon-draw" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
        target: `<svg class="anim-icon icon-draw" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
        check: `<svg class="anim-icon icon-draw" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
        pin: `<svg class="anim-icon icon-draw" viewBox="0 0 24 24"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/></svg>`,
        refresh: `<svg class="anim-icon icon-draw" viewBox="0 0 24 24"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"/><path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>`,
      };

      // Auth Check
      if (!sessionStorage.getItem("auth")) {
        document.getElementById("login-overlay").style.display = "flex";
      }

      async function doLogin(e) {
        e.preventDefault();
        const u = document.getElementById("u").value;
        const p = document.getElementById("p").value;

        try {
          const res = await fetch(`${API}/admin/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: u, password: p }),
          });

          const d = await res.json();

          if (d.success) {
            sessionStorage.setItem("auth", "1");
            sessionStorage.setItem("apiKey", d.apiKey); // Store key
            location.reload();
          } else {
            alert("Invalid Credentials");
          }
        } catch (err) {
          console.error(err);
          alert("Login Error");
        }
      }

      function logout() {
        sessionStorage.removeItem("auth");
        sessionStorage.removeItem("apiKey");
        location.reload();
      }

      let data = [];
      let isTrash = false;

      async function load() {
        try {
          const key = sessionStorage.getItem("apiKey") || "";
          const r = await fetch(`${API}/meetings`, {
            headers: { "x-api-key": key },
          });
          const d = await r.json();
          data = Array.isArray(d) ? d : d.meetings || [];
          refresh();
        } catch (e) {
          console.error(e);
        }
      }

      function refresh() {
        const q = document.getElementById("search").value.toLowerCase();
        const ds = document.getElementById("d-start").value;
        const de = document.getElementById("d-end").value;

        const filtered = data.filter((m) => {
          if (isTrash !== !!m.deleted_at) return false;
          if (ds && new Date(m.created_at) < new Date(ds)) return false;
          if (de && new Date(m.created_at) > new Date(de)) return false;
          if (q && !(m.name + m.summary).toLowerCase().includes(q))
            return false;
          return true;
        });
        render(filtered);
      }

      function reset() {
        document.querySelectorAll("input").forEach((i) => (i.value = ""));
        refresh();
      }

      function switchTab(trash) {
        isTrash = trash;
        document.getElementById("tab-feed").className = `nav-pill ${
          !trash ? "active" : ""
        }`;
        document.getElementById("tab-arch").className = `nav-pill ${
          trash ? "active" : ""
        }`;
        refresh();
      }

      function render(list) {
        const con = document.getElementById("feed");
        if (!list.length) {
          con.innerHTML = `<div style="text-align:center; padding: 100px; color:var(--text-tertiary);"><svg class="anim-icon" style="width:48px;height:48px;opacity:0.3;margin-bottom:16px" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><br>No intelligence found for selected timeframe.</div>`;
          return;
        }

        con.innerHTML = list
          .map((m) => {
            const date = new Date(m.created_at);
            const info = parse(m);

            // Meta Calculations
            const trans = m.elevenlabs_transcript || m.client_transcript || "";
            const wc =
              trans.trim().length > 0 ? trans.trim().split(/\s+/).length : 0;
            const min = wc > 0 ? Math.ceil(wc / 200) : 0;
            const metaText =
              wc > 0 ? ` &bull; ${wc} words &bull; ${min} min read` : "";

            // Capitalization
            let title = m.name || "Untitled Session";
            if (title.length > 0)
              title = title.charAt(0).toUpperCase() + title.slice(1);

            return `
                <div class="meeting-card" id="c-${m.id}">
                    <div class="card-header" onclick="toggle('${m.id}')">
                        <div class="header-meta">
                            <div class="date-badge">
                                <span style="background:var(--accent); width:6px; height:6px; border-radius:50%"></span>
                                ${date.toLocaleDateString("en-US", {
                                  month: "long",
                                  day: "numeric",
                                })} ${metaText}
                            </div>
                            <div class="expand-circle">
                                <svg class="anim-icon" style="width:20px" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
                            </div>
                        </div>
                        <div class="topic-headline">${title}</div>
                        <div class="topic-preview">${info.preview}</div>
                    </div>
                    
                    <div class="card-content">
                        ${transformMarkdown(m.summary)}
                        
                        <div class="transcript-module" id="tm-${m.id}">
                            <div class="transcript-head" onclick="toggleT(event, '${
                              m.id
                            }')">
                                <span>Voice Transcript</span>
                                <svg class="anim-icon" style="width:16px; transition:transform 0.3s" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
                            </div>
                            <div class="transcript-body">
                                ${(
                                  m.elevenlabs_transcript ||
                                  m.client_transcript ||
                                  "Audio transcript processed but returned empty."
                                ).replace(/\n/g, "<br>")}
                            </div>
                        </div>
                        
                        <div class="action-bar">
                           <button class="btn" onclick="play('${m.id}')">
                               <svg class="anim-icon" style="width:18px" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                               Play Audio
                           </button>
                           
                           <button class="btn btn-green" onclick="dl('${
                             m.id
                           }')">
                               <svg class="anim-icon" style="width:18px" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                               Download
                           </button>
                           
                           ${
                             isTrash
                               ? `<button class="btn btn-primary" onclick="rest('${m.id}')">
                                    <svg class="anim-icon" style="width:18px" viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg> 
                                    Restore
                                </button>`
                               : `<button class="btn btn-red" onclick="arch('${m.id}')">
                                    <svg class="anim-icon" style="width:18px" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                    Archive
                                </button>`
                           }
                        </div>
                        <div id="p-${m.id}" style="margin-top:20px"></div>
                    </div>
                </div>`;
          })
          .join("");
      }

      // Fix parsing for inline bullets and numbered lists
      function transformMarkdown(md) {
        if (!md || md == "[]") return "";

        // Fix blobs: Force breaks before bullet chars if not at start of line
        let clean = md
          .replace(/---/g, "")
          .replace(/([^\n>])\s*‚Ä¢/g, "$1\n‚Ä¢")
          .replace(/([^\n>])\s*\[/g, "$1\n[")
          .replace(/([^\n>])\s*(\d+\.)/g, "$1\n$2");

        // Wrap sections with New Structure (No padding left)
        let html = clean
          .replace(/#\s*(?:üìù)?\s*Meeting Summary/gi, "")
          .replace(
            /##\s*(?:üéØ)?\s*Key Discussion Points/gi,
            `</div><div class="summary-block"><div class="block-header-row"><div class="block-icon">${ICONS.target}</div><div class="block-title">Key Points</div></div><div class="readable-text">`
          )
          .replace(
            /##\s*(?:‚úÖ)?\s*Decisions Made/gi,
            `</div><div class="summary-block"><div class="block-header-row"><div class="block-icon">${ICONS.check}</div><div class="block-title">Decisions</div></div><div class="readable-text">`
          )
          .replace(
            /##\s*(?:üìå)?\s*Action Items/gi,
            `</div><div class="action-block summary-block"><div class="block-header-row"><div class="block-icon">${ICONS.pin}</div><div class="block-title">Actions</div></div><div class="readable-text">`
          )
          .replace(
            /##\s*(?:üîÑ)?\s*Next Steps/gi,
            `</div><div class="summary-block"><div class="block-header-row"><div class="block-icon">${ICONS.refresh}</div><div class="block-title">Next Steps</div></div><div class="readable-text">`
          );

        if (!html.startsWith("</div>")) {
          html =
            `<div class="summary-block"><div class="block-header-row"><div class="block-icon">${ICONS.summary}</div><div class="block-title">Executive Summary</div></div><div class="readable-text">` +
            html;
        }
        html += "</div></div>";

        // Format Content
        html = html
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(
            /^\s*-\s+\[ \]\s+(.*)/gm,
            '<li><div class="checkbox"></div><div>$1</div></li>'
          )
          .replace(
            /^\s*-\s+\[x\]\s+(.*)/gm,
            '<li><div class="checkbox" style="background:var(--text-secondary)"></div><div>$1</div></li>'
          )
          .replace(
            /^\s*[-*‚Ä¢]\s+(.*)/gm,
            '<li><div class="bullet"></div><div>$1</div></li>'
          )
          .replace(
            /^\s*(\d+\.)\s+(.*)/gm,
            '<li><div class="num-marker">$1</div><div>$2</div></li>'
          )
          .replace(/(<li>.*<\/li>)/s, "<ul>$1</ul>")
          .replace(/<\/ul>\s*<ul>/g, "")
          .replace(
            /<div class="summary-block">.*?<div class="readable-text">\s*<\/div><\/div>/g,
            ""
          );

        return html;
      }

      function parse(m) {
        let t = m.summary || "";
        let c = t.replace(/[#*`]/g, "").trim();
        let p = "Click to view details.";
        const mat = c.match(/Meeting Topic:\s*(.*)/i);
        if (mat) p = mat[1];
        return { preview: p };
      }

      function toggle(id) {
        document.querySelectorAll(".meeting-card.active").forEach((c) => {
          if (c.id !== "c-" + id) c.classList.remove("active");
        });
        document.getElementById("c-" + id).classList.toggle("active");
      }
      function toggleT(e, id) {
        e.stopPropagation();
        document.getElementById("tm-" + id).classList.toggle("open");
      }

      async function play(id) {
        const b = document.getElementById("p-" + id);
        if (b.innerHTML) return;
        try {
          // Get key from session
          const key = sessionStorage.getItem("apiKey") || "";
          const r = await fetch(`${API}/audio/${id}`, {
            headers: { "x-api-key": key },
          });
          const d = await r.json();
          if (d.url)
            b.innerHTML = `<audio controls autoplay src="${d.url}" style="width:100%"></audio>`;
        } catch (e) {}
      }

      async function arch(id) {
        const key = sessionStorage.getItem("apiKey") || "";
        if (confirm("Archive?")) {
          await fetch(`${API}/meetings/${id}`, {
            method: "DELETE",
            headers: { "x-api-key": key },
          });
          load();
        }
      }
      async function rest(id) {
        const key = sessionStorage.getItem("apiKey") || "";
        await fetch(`${API}/meetings/${id}/restore`, {
          method: "POST",
          headers: { "x-api-key": key },
        });
        load();
      }
      async function dl(id) {
        const key = sessionStorage.getItem("apiKey") || "";
        const r = await fetch(`${API}/audio/${id}`, {
          headers: { "x-api-key": key },
        });
        const d = await r.json();
        if (d.url) {
          const a = document.createElement("a");
          a.href = d.url;
          a.download = `celiyo_${id}.webm`;
          a.click();
        }
      }

      load();
    </script>
  </body>
</html>
